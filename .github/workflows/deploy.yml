name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  DB_HOST: "rc1b-tptaie72mntboqdv.mdb.yandexcloud.net"
  DB_PORT: "6432"
  DB_NAME: "examyandexapp"
  DB_USER: "user"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest .
        yc container registry configure-docker
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        echo "âœ… Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        kubectl cluster-info
        kubectl get nodes
        echo "âœ… kubectl configured successfully"

    - name: Create namespace and secrets
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        if ! kubectl get namespace examyandexapp > /dev/null 2>&1; then
          kubectl create namespace examyandexapp
          echo "âœ… Namespace examyandexapp created"
        else
          echo "âœ… Namespace examyandexapp already exists"
        fi
        
        kubectl create secret generic postgres-secret \
          --namespace examyandexapp \
          --from-literal=db-host=${{ env.DB_HOST }} \
          --from-literal=db-port=${{ env.DB_PORT }} \
          --from-literal=db-name=${{ env.DB_NAME }} \
          --from-literal=db-user=${{ env.DB_USER }} \
          --from-literal=db-password=${{ secrets.DB_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl create secret generic objectstorage-secret \
          --namespace examyandexapp \
          --from-literal=access-key=${{ secrets.OBJECTSTORAGE_ACCESS_KEY }} \
          --from-literal=secret-key=${{ secrets.OBJECTSTORAGE_SECRET_KEY }} \
          --from-literal=bucket-name=${{ secrets.OBJECTSTORAGE_BUCKET_NAME }} \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "âœ… Secrets created successfully"
        kubectl get secrets -n examyandexapp

    - name: Deploy application
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        kubectl delete deployment examyandexapp -n examyandexapp --ignore-not-found=true
        sleep 10
        
        kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: examyandexapp
  namespace: examyandexapp
spec:
  replicas: 2
  selector:
    matchLabels:
      app: examyandexapp
  template:
    metadata:
      labels:
        app: examyandexapp
    spec:
      containers:
      - name: examyandexapp
        image: cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        ports:
        - containerPort: 8080
        env:
        - name: DB_HOST
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: db-host
        - name: DB_PORT
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: db-port
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: db-name
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: db-user
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: db-password
        - name: ObjectStorage__AccessKey
          valueFrom:
            secretKeyRef:
              name: objectstorage-secret
              key: access-key
        - name: ObjectStorage__SecretKey
          valueFrom:
            secretKeyRef:
              name: objectstorage-secret
              key: secret-key
        - name: ObjectStorage__BucketName
          valueFrom:
            secretKeyRef:
              name: objectstorage-secret
              key: bucket-name
        - name: ObjectStorage__ServiceUrl
          value: "https://storage.yandexcloud.net"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
---
apiVersion: v1
kind: Service
metadata:
  name: examyandexapp-service
  namespace: examyandexapp
spec:
  selector:
    app: examyandexapp
  ports:
  - port: 80
    targetPort: 8080
  type: LoadBalancer
EOF
        
        echo "ðŸš€ New deployment applied, waiting for pods to start..."
        sleep 30
        
        echo "=== Current Pod Status ==="
        kubectl get pods -n examyandexapp -o wide
        
        echo "=== New Pod Logs ==="
        for pod in $(kubectl get pods -n examyandexapp -o jsonpath='{.items[*].metadata.name}'); do
          echo "--- Logs for pod $pod ---"
          kubectl logs -n examyandexapp $pod --tail=10 || echo "No logs available for $pod"
        done
        
        echo "=== Waiting for rollout to complete ==="
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=600s
        
        echo "=== Final Status ==="
        kubectl get pods -n examyandexapp -o wide
        kubectl get service -n examyandexapp
        
        echo "ðŸŽ‰ Application deployed successfully!"