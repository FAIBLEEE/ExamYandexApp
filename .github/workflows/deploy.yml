name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  DB_HOST: "rc1b-tptaie72mntboqdv.mdb.yandexcloud.net"
  DB_PORT: "6432"
  DB_NAME: "examyandexapp"
  DB_USER: "user"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "‚úÖ Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        # Build Docker image
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest .
        
        # Login to Yandex Container Registry
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        echo "‚úÖ Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
        kubectl cluster-info
        kubectl get nodes
        echo "‚úÖ kubectl configured successfully"

    - name: Create namespace and secrets
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –°–æ–∑–¥–∞–Ω–∏–µ namespace (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        if ! kubectl get namespace examyandexapp > /dev/null 2>&1; then
          kubectl create namespace examyandexapp
          echo "‚úÖ Namespace examyandexapp created"
        else
          echo "‚úÖ Namespace examyandexapp already exists"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ namespace —Å–æ–∑–¥–∞–Ω
        kubectl get namespaces | grep examyandexapp
        
        # –°–æ–∑–¥–∞–Ω–∏–µ PostgreSQL secret
        kubectl create secret generic postgres-secret \
          --namespace examyandexapp \
          --from-literal=db-host=${{ env.DB_HOST }} \
          --from-literal=db-port=${{ env.DB_PORT }} \
          --from-literal=db-name=${{ env.DB_NAME }} \
          --from-literal=db-user=${{ env.DB_USER }} \
          --from-literal=db-password=${{ secrets.DB_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -
        
        # –°–æ–∑–¥–∞–Ω–∏–µ Object Storage secret
        kubectl create secret generic objectstorage-secret \
          --namespace examyandexapp \
          --from-literal=access-key=${{ secrets.OBJECTSTORAGE_ACCESS_KEY }} \
          --from-literal=secret-key=${{ secrets.OBJECTSTORAGE_SECRET_KEY }} \
          --from-literal=bucket-name=${{ secrets.OBJECTSTORAGE_BUCKET_NAME }} \
          --dry-run=client -o yaml | kubectl apply -f -

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
        echo "‚úÖ Secrets created successfully"
        kubectl get secrets -n examyandexapp

    - name: Deploy application
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ deployment
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: examyandexapp
          namespace: examyandexapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: examyandexapp
          template:
            metadata:
              labels:
                app: examyandexapp
            spec:
              containers:
              - name: examyandexapp
                image: cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
                ports:
                - containerPort: 8080
                env:
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-host
                - name: DB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-port
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-name
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-user
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-password
                - name: ObjectStorage__AccessKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: access-key
                - name: ObjectStorage__SecretKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: secret-key
                - name: ObjectStorage__BucketName
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: bucket-name
                - name: ObjectStorage__ServiceUrl
                  value: "https://storage.yandexcloud.net"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 5
                  periodSeconds: 5
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: examyandexapp-service
          namespace: examyandexapp
        spec:
          selector:
            app: examyandexapp
          ports:
          - port: 80
            targetPort: 8080
          type: LoadBalancer
        EOF
        
        echo "üöÄ Deployment applied, waiting for pods to start..."
        
        # –î–∞–µ–º –ø–æ–¥–∞–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        sleep 30
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤
        echo "=== Current Pod Status ==="
        kubectl get pods -n examyandexapp -o wide
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        echo "=== Recent Events ==="
        kubectl get events -n examyandexapp --sort-by='.lastTimestamp' | tail -10
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ–¥—ã
        echo "=== Pod Logs (if any) ==="
        for pod in $(kubectl get pods -n examyandexapp -o jsonpath='{.items[*].metadata.name}'); do
          echo "--- Logs for pod $pod ---"
          kubectl logs -n examyandexapp $pod --tail=20 || echo "No logs available for $pod"
        done
        
        # –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
        echo "=== Waiting for rollout to complete ==="
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=600s
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        echo "=== Final Pod Status ==="
        kubectl get pods -n examyandexapp -o wide
        
        echo "=== Service Info ==="
        kubectl get service -n examyandexapp
        
        echo "üéâ Application deployed successfully!"

    - name: Debug if failed
      if: failure()
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "=== DEBUG INFORMATION ==="
        echo "=== Pods Details ==="
        kubectl get pods -n examyandexapp -o wide
        
        echo "=== Pods Description ==="
        for pod in $(kubectl get pods -n examyandexapp -o jsonpath='{.items[*].metadata.name}'); do
          echo "--- Description for pod $pod ---"
          kubectl describe pod -n examyandexapp $pod
        done
        
        echo "=== Events ==="
        kubectl get events -n examyandexapp --sort-by='.lastTimestamp' | tail -20
        
        echo "=== Deployment Description ==="
        kubectl describe deployment -n examyandexapp examyandexapp
        
        echo "=== Secrets Check ==="
        kubectl get secrets -n examyandexapp