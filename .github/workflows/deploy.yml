name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… Application built successfully"

    - name: Setup Yandex Cloud CLI
      uses: yc-actions/yc-initialize@v2
      with:
        yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_KEY }}

    - name: Build and push Docker image
      run: |
        # Build Docker image
        docker build -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest .
        
        # Login to Yandex Container Registry
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest
        echo "âœ… Docker image pushed to Yandex Container Registry"

    - name: Setup kubectl
      uses: yc-actions/yc-setup-k8s@v2
      with:
        cluster-id: ${{ secrets.YC_K8S_CLUSTER_ID }}

    - name: Deploy to Kubernetes
      run: |
        # Update deployment with new image
        kubectl set image deployment/examyandexapp examyandexapp=cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest -n examyandexapp
        
        # Wait for rollout to complete
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=300s
        
        # Verify deployment
        kubectl get pods -n examyandexapp
        echo "ðŸš€ Deployment completed successfully!"