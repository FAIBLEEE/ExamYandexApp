name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  DB_HOST: "rc1b-tptaie72mntboqdv.mdb.yandexcloud.net"
  DB_PORT: "6432"
  DB_NAME: "examyandexapp"
  DB_USER: "user"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "‚úÖ Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        # Build Docker image
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest .
        
        # Login to Yandex Container Registry
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        echo "‚úÖ Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
        kubectl cluster-info
        kubectl get nodes
        echo "‚úÖ kubectl configured successfully"

    - name: Create namespace and secrets
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –°–æ–∑–¥–∞–Ω–∏–µ namespace (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        if ! kubectl get namespace examyandexapp > /dev/null 2>&1; then
          kubectl create namespace examyandexapp
          echo "‚úÖ Namespace examyandexapp created"
        else
          echo "‚úÖ Namespace examyandexapp already exists"
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ namespace —Å–æ–∑–¥–∞–Ω
        kubectl get namespaces | grep examyandexapp
        
        # –°–æ–∑–¥–∞–Ω–∏–µ PostgreSQL secret
        kubectl create secret generic postgres-secret \
          --namespace examyandexapp \
          --from-literal=db-host=${{ env.DB_HOST }} \
          --from-literal=db-port=${{ env.DB_PORT }} \
          --from-literal=db-name=${{ env.DB_NAME }} \
          --from-literal=db-user=${{ env.DB_USER }} \
          --from-literal=db-password=${{ secrets.DB_PASSWORD }} \
          --dry-run=client -o yaml | kubectl apply -f -
        
        # –°–æ–∑–¥–∞–Ω–∏–µ Object Storage secret
        kubectl create secret generic objectstorage-secret \
          --namespace examyandexapp \
          --from-literal=access-key=${{ secrets.OBJECTSTORAGE_ACCESS_KEY }} \
          --from-literal=secret-key=${{ secrets.OBJECTSTORAGE_SECRET_KEY }} \
          --from-literal=bucket-name=${{ secrets.OBJECTSTORAGE_BUCKET_NAME }} \
          --dry-run=client -o yaml | kubectl apply -f -

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã
        echo "‚úÖ Secrets created successfully"
        kubectl get secrets -n examyandexapp

    - name: Deploy application
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ deployment
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: examyandexapp
          namespace: examyandexapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: examyandexapp
          template:
            metadata:
              labels:
                app: examyandexapp
            spec:
              containers:
              - name: examyandexapp
                image: cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
                ports:
                - containerPort: 8080
                env:
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-host
                - name: DB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-port
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-name
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-user
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-password
                - name: ObjectStorage__AccessKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: access-key
                - name: ObjectStorage__SecretKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: secret-key
                - name: ObjectStorage__BucketName
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: bucket-name
                - name: ObjectStorage__ServiceUrl
                  value: "https://storage.yandexcloud.net"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: examyandexapp-service
          namespace: examyandexapp
        spec:
          selector:
            app: examyandexapp
          ports:
          - port: 80
            targetPort: 8080
          type: LoadBalancer
        EOF
        
        # –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=300s
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–∏—Å–µ
        kubectl get service -n examyandexapp
        echo "üöÄ Application deployed successfully!"