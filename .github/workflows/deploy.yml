name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "âœ… Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        # Build Docker image
        docker build -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest .
        
        # Login to Yandex Container Registry (Ð±ÐµÐ· --force)
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest
        echo "âœ… Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        kubectl get nodes
        echo "âœ… kubectl configured successfully"

    - name: Deploy to Kubernetes
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        # Update deployment with new image
        kubectl set image deployment/examyandexapp examyandexapp=cr.yandex/${{ secrets.YC_REGISTRY_ID }}/examyandexapp:latest -n examyandexapp
        
        # Wait for rollout to complete
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=300s
        
        # Verify deployment
        kubectl get pods -n examyandexapp
        echo "ðŸš€ Deployment completed successfully!"