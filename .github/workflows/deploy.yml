name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  DB_HOST: "rc1b-tptaie72mntboqdv.mdb.yandexcloud.net"
  DB_PORT: "6432"
  DB_NAME: "examyandexapp"
  DB_USER: "user"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "‚úÖ Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Check cluster status
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "=== Cluster Information ==="
        yc managed-kubernetes cluster get ${{ secrets.YC_K8S_CLUSTER_ID }} || echo "Cluster not found or inaccessible"
        
        echo "=== Node Groups ==="
        yc managed-kubernetes node-group list || echo "No node groups found"
        
        echo "=== Nodes in Cluster ==="
        kubectl get nodes || echo "Cannot get nodes"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ —Å —Ö—ç—à–µ–º –∫–æ–º–º–∏—Ç–∞ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        SHORT_SHA=$(git rev-parse --short HEAD)
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA .
        
        # Login to Yandex Container Registry
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA
        echo "‚úÖ Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
        kubectl cluster-info
        kubectl get nodes
        echo "‚úÖ kubectl configured successfully"

    - name: Create namespace and secrets
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –°–æ–∑–¥–∞–Ω–∏–µ namespace
        if ! kubectl get namespace examyandexapp > /dev/null 2>&1; then
          kubectl create namespace examyandexapp
          echo "‚úÖ Namespace examyandexapp created"
        else
          echo "‚úÖ Namespace examyandexapp already exists"
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ PostgreSQL secret (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if ! kubectl get secret postgres-secret -n examyandexapp > /dev/null 2>&1; then
          kubectl create secret generic postgres-secret \
            --namespace examyandexapp \
            --from-literal=db-host=${{ env.DB_HOST }} \
            --from-literal=db-port=${{ env.DB_PORT }} \
            --from-literal=db-name=${{ env.DB_NAME }} \
            --from-literal=db-user=${{ env.DB_USER }} \
            --from-literal=db-password=${{ secrets.DB_PASSWORD }}
          echo "‚úÖ PostgreSQL secret created"
        else
          echo "‚úÖ PostgreSQL secret already exists"
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ Object Storage secret (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if ! kubectl get secret objectstorage-secret -n examyandexapp > /dev/null 2>&1; then
          kubectl create secret generic objectstorage-secret \
            --namespace examyandexapp \
            --from-literal=access-key=${{ secrets.OBJECTSTORAGE_ACCESS_KEY }} \
            --from-literal=secret-key=${{ secrets.OBJECTSTORAGE_SECRET_KEY }} \
            --from-literal=bucket-name=${{ secrets.OBJECTSTORAGE_BUCKET_NAME }}
          echo "‚úÖ Object Storage secret created"
        else
          echo "‚úÖ Object Storage secret already exists"
        fi

    - name: Wait for nodes to be ready
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "‚è≥ Waiting for nodes to become available..."
        TIMEOUT=300
        INTERVAL=10
        COUNTER=0
        
        while [ $COUNTER -lt $TIMEOUT ]; do
          NODES_READY=$(kubectl get nodes --no-headers | grep -c "Ready")
          if [ $NODES_READY -ge 1 ]; then
            echo "‚úÖ Nodes are ready!"
            kubectl get nodes
            break
          fi
          
          echo "Waiting for nodes... ($((COUNTER))s)"
          sleep $INTERVAL
          COUNTER=$((COUNTER + INTERVAL))
        done
        
        if [ $COUNTER -ge $TIMEOUT ]; then
          echo "‚ùå Timeout waiting for nodes"
          kubectl get nodes
          exit 1
        fi

    - name: Deploy application
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "Using image tag: $SHORT_SHA"
        
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        echo "=== Current Deployment State ==="
        kubectl get deployment examyandexapp -n examyandexapp -o wide || echo "Deployment not found, will create new"
        kubectl get pods -n examyandexapp -o wide || echo "No pods found"
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ deployment —Å health checks
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: examyandexapp
          namespace: examyandexapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: examyandexapp
          strategy:
            type: RollingUpdate
            rollingUpdate:
              maxSurge: 1
              maxUnavailable: 0
          template:
            metadata:
              labels:
                app: examyandexapp
              annotations:
                deployment.kubernetes.io/revision: "$SHORT_SHA"
            spec:
              containers:
              - name: examyandexapp
                image: cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA
                ports:
                - containerPort: 8080
                env:
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-host
                - name: DB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-port
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-name
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-user
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-password
                - name: ObjectStorage__AccessKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: access-key
                - name: ObjectStorage__SecretKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: secret-key
                - name: ObjectStorage__BucketName
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: bucket-name
                - name: ObjectStorage__ServiceUrl
                  value: "https://storage.yandexcloud.net"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                # Health checks —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 120
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                  initialDelaySeconds: 60
                  periodSeconds: 15
                  timeoutSeconds: 5
                  failureThreshold: 3
        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: examyandexapp-service
          namespace: examyandexapp
        spec:
          selector:
            app: examyandexapp
          ports:
          - port: 80
            targetPort: 8080
          type: LoadBalancer
        EOF
        
        echo "üöÄ Deployment applied, waiting for rollout..."
        
        # –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
        echo "=== Waiting for rollout ==="
        if kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=600s; then
          echo "‚úÖ Rollout completed successfully"
        else
          echo "‚ùå Rollout failed or timed out, checking status..."
          
          # –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
          echo "=== Pods Status ==="
          kubectl get pods -n examyandexapp -o wide
          
          echo "=== Deployment Description ==="
          kubectl describe deployment examyandexapp -n examyandexapp
          
          echo "=== Pods Description ==="
          for pod in $(kubectl get pods -n examyandexapp -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Pod: $pod ---"
            kubectl describe pod $pod -n examyandexapp
          done
          
          echo "=== Pods Logs ==="
          for pod in $(kubectl get pods -n examyandexapp -o jsonpath='{.items[*].metadata.name}'); do
            echo "--- Logs for pod: $pod ---"
            kubectl logs $pod -n examyandexapp --tail=50 || echo "No logs available"
          done
          
          exit 1
        fi
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        echo "=== Final Status ==="
        kubectl get pods -n examyandexapp -o wide
        kubectl get service -n examyandexapp
        
        echo "üéâ Application deployed successfully!"

    - name: Verify health endpoints
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "=== Health Check Verification ==="
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å —Ç–æ—á–Ω–æ –±—ã–ª –≥–æ—Ç–æ–≤
        sleep 30
        
        # –ü–æ–ª—É—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–∏—Å–∞
        SERVICE_IP=$(kubectl get service examyandexapp-service -n examyandexapp -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        if [ -n "$SERVICE_IP" ]; then
          echo "Testing health endpoint at: http://$SERVICE_IP/health"
          curl -f http://$SERVICE_IP/health || echo "Health check failed"
        else
          echo "Service IP not available yet"
        fi
        
        echo "‚úÖ Health check completed"