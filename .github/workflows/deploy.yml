name: Deploy to Yandex Cloud

on:
  push:
    branches: [ main ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  DB_HOST: "rc1b-tptaie72mntboqdv.mdb.yandexcloud.net"
  DB_PORT: "6432"
  DB_NAME: "examyandexapp"
  DB_USER: "user"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build application
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        echo "‚úÖ Application built successfully"

    - name: Install Yandex Cloud CLI
      run: |
        curl -s https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -a
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc --version

    - name: Configure Yandex Cloud CLI
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        echo '${{ secrets.YC_SA_JSON_KEY }}' > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "Yandex Cloud CLI configured successfully"

    - name: Check cluster status
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "=== Cluster Information ==="
        yc managed-kubernetes cluster get ${{ secrets.YC_K8S_CLUSTER_ID }} || echo "Cluster not found or inaccessible"
        
        echo "=== Node Groups ==="
        yc managed-kubernetes node-group list || echo "No node groups found"
        
        echo "=== Nodes in Cluster ==="
        kubectl get nodes || echo "Cannot get nodes"

    - name: Build and push Docker image
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ —Å —Ö—ç—à–µ–º –∫–æ–º–º–∏—Ç–∞ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
        SHORT_SHA=$(git rev-parse --short HEAD)
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest -t cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA .
        
        # Login to Yandex Container Registry
        yc container registry configure-docker
        
        # Push image
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:latest
        docker push cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA
        echo "‚úÖ Docker image pushed to Yandex Container Registry"

    - name: Configure kubectl
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        yc managed-kubernetes cluster get-credentials ${{ secrets.YC_K8S_CLUSTER_ID }} --external
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
        kubectl cluster-info
        kubectl get nodes
        echo "‚úÖ kubectl configured successfully"

    - name: Create namespace and secrets
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        # –°–æ–∑–¥–∞–Ω–∏–µ namespace
        if ! kubectl get namespace examyandexapp > /dev/null 2>&1; then
          kubectl create namespace examyandexapp
          echo "‚úÖ Namespace examyandexapp created"
        else
          echo "‚úÖ Namespace examyandexapp already exists"
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ PostgreSQL secret (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if ! kubectl get secret postgres-secret -n examyandexapp > /dev/null 2>&1; then
          kubectl create secret generic postgres-secret \
            --namespace examyandexapp \
            --from-literal=db-host=${{ env.DB_HOST }} \
            --from-literal=db-port=${{ env.DB_PORT }} \
            --from-literal=db-name=${{ env.DB_NAME }} \
            --from-literal=db-user=${{ env.DB_USER }} \
            --from-literal=db-password=${{ secrets.DB_PASSWORD }}
          echo "‚úÖ PostgreSQL secret created"
        else
          echo "‚úÖ PostgreSQL secret already exists"
        fi
        
        # –°–æ–∑–¥–∞–Ω–∏–µ Object Storage secret (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if ! kubectl get secret objectstorage-secret -n examyandexapp > /dev/null 2>&1; then
          kubectl create secret generic objectstorage-secret \
            --namespace examyandexapp \
            --from-literal=access-key=${{ secrets.OBJECTSTORAGE_ACCESS_KEY }} \
            --from-literal=secret-key=${{ secrets.OBJECTSTORAGE_SECRET_KEY }} \
            --from-literal=bucket-name=${{ secrets.OBJECTSTORAGE_BUCKET_NAME }}
          echo "‚úÖ Object Storage secret created"
        else
          echo "‚úÖ Object Storage secret already exists"
        fi

    - name: Wait for nodes to be ready
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "‚è≥ Waiting for nodes to become available..."
        TIMEOUT=300
        INTERVAL=10
        COUNTER=0
        
        while [ $COUNTER -lt $TIMEOUT ]; do
          NODES_READY=$(kubectl get nodes --no-headers | grep -c "Ready")
          if [ $NODES_READY -ge 1 ]; then
            echo "‚úÖ Nodes are ready!"
            kubectl get nodes
            break
          fi
          
          echo "Waiting for nodes... ($((COUNTER))s)"
          sleep $INTERVAL
          COUNTER=$((COUNTER + INTERVAL))
        done
        
        if [ $COUNTER -ge $TIMEOUT ]; then
          echo "‚ùå Timeout waiting for nodes"
          kubectl get nodes
          exit 1
        fi

    - name: Deploy application
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ deployment —Å —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: examyandexapp
          namespace: examyandexapp
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: examyandexapp
          strategy:
            type: RollingUpdate
            rollingUpdate:
              maxSurge: 1
              maxUnavailable: 0
          template:
            metadata:
              labels:
                app: examyandexapp
            spec:
              containers:
              - name: examyandexapp
                image: cr.yandex/${{ env.REGISTRY_ID }}/examyandexapp:$SHORT_SHA
                ports:
                - containerPort: 8080
                env:
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-host
                - name: DB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-port
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-name
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-user
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: postgres-secret
                      key: db-password
                - name: ObjectStorage__AccessKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: access-key
                - name: ObjectStorage__SecretKey
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: secret-key
                - name: ObjectStorage__BucketName
                  valueFrom:
                    secretKeyRef:
                      name: objectstorage-secret
                      key: bucket-name
                - name: ObjectStorage__ServiceUrl
                  value: "https://storage.yandexcloud.net"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                    scheme: HTTP
                  initialDelaySeconds: 60  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8080
                    scheme: HTTP
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
                # –î–æ–±–∞–≤–ª—è–µ–º startup probe –¥–ª—è ASP.NET Core –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
                startupProbe:
                  httpGet:
                    path: /health
                    port: 8080
                    scheme: HTTP
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 10
        EOF
        
        echo "üöÄ Deployment applied"
        
        # –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
        kubectl rollout status deployment/examyandexapp -n examyandexapp --timeout=600s
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        echo "=== Final Status ==="
        kubectl get pods -n examyandexapp -o wide
        kubectl get service -n examyandexapp
        
        echo "üéâ Application deployed successfully!"

    - name: Verify deployment
      run: |
        source $HOME/.bashrc
        export PATH=$HOME/yandex-cloud/bin:$PATH
        
        echo "=== Verification ==="
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –ø–æ–¥—ã
        kubectl get pods -n examyandexapp
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥–∞
        LATEST_POD=$(kubectl get pods -n examyandexapp --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}')
        echo "=== Logs from latest pod: $LATEST_POD ==="
        kubectl logs -n examyandexapp $LATEST_POD --tail=50
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å readiness/liveness probes
        echo "=== Pod Details ==="
        kubectl describe pod -n examyandexapp $LATEST_POD | grep -A 10 "Liveness\|Readiness"
        
        echo "‚úÖ Deployment verification completed"